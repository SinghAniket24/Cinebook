<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Processing Booking... | CineBook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    <script src="js/auth-interceptor.js"></script> 
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Manrope', 'sans-serif'] },
                    colors: { brand: { red: '#E50914', dark: '#0A0A0A', green: '#1EA83C' } }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0A0A0A; color: white; display: flex; align-items: center; justify-content: center; height: 100vh; }
        .ticket-card { background: #1a1a1a; border-radius: 16px; overflow: hidden; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .ticket-card::before, .ticket-card::after { content: ''; position: absolute; top: 70%; width: 30px; height: 30px; background: #0A0A0A; border-radius: 50%; }
        .ticket-card::before { left: -15px; } .ticket-card::after { right: -15px; }
        .dashed-line { border-top: 2px dashed #333; margin: 2rem 0; }
        .loader { border: 4px solid #333; border-top: 4px solid #E50914; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="processing-view" class="text-center">
        <div class="loader"></div>
        <h2 class="text-xl font-bold">Verifying Payment...</h2>
        <p class="text-gray-400 text-sm mt-2" id="status-text">Please wait while we confirm your seats.</p>
    </div>

    <div id="ticket-view" class="ticket-card w-full max-w-sm p-8 text-center hidden">
        <div class="w-16 h-16 bg-green-900/20 rounded-full flex items-center justify-center mx-auto mb-6">
            <span class="material-symbols-rounded text-4xl text-green-500">check_circle</span>
        </div>
        <h1 class="text-2xl font-bold mb-1">Booking Confirmed!</h1>
        <p class="text-gray-400 text-sm mb-6">Sent to <span id="user-email" class="text-white"></span>.</p>

        <div class="bg-[#222] p-4 rounded-lg mb-6">
            <h2 class="font-bold text-lg text-white" id="ticket-movie-title"></h2>
            <p class="text-gray-400 text-xs mt-1">PVR Cinemas â€¢ Today</p>
            <div class="mt-3 flex justify-center gap-2 flex-wrap" id="seat-badge-container"></div>
        </div>

        <div class="dashed-line"></div>
        <div class="flex flex-col items-center gap-2">
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=CineBook-Confirmed" class="rounded-lg opacity-80">
            <p class="text-[10px] text-gray-500 tracking-widest uppercase mt-2">Scan at Entry</p>
        </div>
        <a href="home.html" onclick="sessionStorage.removeItem('pendingBooking')" class="block w-full bg-brand-red py-3 rounded-lg font-bold mt-8 hover:bg-red-700 transition">Back to Home</a>
    </div>

    <script>
        const API_GATEWAY = "http://localhost:8080";

        document.addEventListener("DOMContentLoaded", async () => {
            const dataStr = sessionStorage.getItem('pendingBooking');
            if (!dataStr) {
                document.getElementById('processing-view').innerHTML = `<h2 class='text-red-500 font-bold'>No Booking Found</h2><a href='home.html' class='text-white underline mt-4 block'>Go Home</a>`;
                return;
            }

            const data = JSON.parse(dataStr);
            const user = data.user;
            const statusText = document.getElementById('status-text');

            try {
                // Loop through seats and call Backend API
                for (const seatId of data.seatIds) {
                    statusText.innerText = `Booking Seat ${seatId}...`;
                    // PASS THE TITLE HERE
                    const url = `${API_GATEWAY}/bookings/create?userId=${user.userId}&seatId=${seatId}&movieId=${data.movieId}&email=${user.email}&movieTitle=${encodeURIComponent(data.movieTitle)}`;
                    await fetch(url, { method: 'GET' });
                }

                // Show Success
                document.getElementById('processing-view').classList.add('hidden');
                document.getElementById('ticket-view').classList.remove('hidden');
                
                document.getElementById('user-email').innerText = user.email;
                document.getElementById('ticket-movie-title').innerText = data.movieTitle;
                
                const seatContainer = document.getElementById('seat-badge-container');
                data.seatIds.forEach(id => {
                    const span = document.createElement('span');
                    span.className = "px-2 py-1 bg-gray-700 rounded text-xs";
                    span.innerText = "Seat " + id;
                    seatContainer.appendChild(span);
                });

            } catch (e) {
                console.error(e);
                statusText.innerText = "Error: " + e.message;
                statusText.className = "text-red-500 text-sm mt-2";
            }
        });
    </script>
</body>
</html>