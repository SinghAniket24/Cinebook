<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Select Theatre | CineBook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
	<script src="js/auth-interceptor.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Manrope', 'sans-serif'] },
                    colors: { brand: { red: '#E50914', dark: '#0A0A0A', card: '#151515' } }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0A0A0A; color: white; }
        .time-btn:hover { background-color: #E50914; color: white; border-color: #E50914; box-shadow: 0 0 10px rgba(229,9,20,0.4); }
        .date-btn.active { background-color: #E50914; color: white; border: none; }
        .date-btn { transition: all 0.2s; }
        .m-ticket::before { content: '●'; color: #4ade80; font-size: 10px; margin-right: 4px; }
        
        /* Map Modal Styles */
        #map-modal { transition: opacity 0.3s ease-in-out; }
        #map { height: 100%; width: 100%; border-radius: 8px; }
    </style>
</head>
<body>

    <div class="relative w-full h-[350px] overflow-hidden">
        <img id="bg-backdrop" src="" class="w-full h-full object-cover opacity-40 blur-sm">
        <div class="absolute inset-0 bg-gradient-to-t from-[#0A0A0A] via-[#0A0A0A]/60 to-transparent flex items-end">
            <div class="max-w-7xl mx-auto px-6 w-full pb-10 flex gap-6 items-end">
                <div class="hidden md:block w-40 rounded-lg overflow-hidden shadow-2xl border border-white/10">
                    <img id="poster-img" src="" class="w-full">
                </div>
                <div>
                    <h1 id="movie-title" class="text-4xl md:text-5xl font-bold text-white mb-2">Loading...</h1>
                    <div class="flex flex-wrap gap-3 text-sm font-semibold text-gray-300">
                        <span class="border border-gray-500 px-2 rounded text-[10px] py-0.5 tracking-wider">UA</span>
                        <span id="genre-tags">Action • Thriller</span>
                        <span>•</span>
                        <span id="release-date">2025</span>
                        <span>•</span>
                        <div class="flex items-center gap-1 bg-white/10 px-2 rounded text-white">
                            <span class="text-green-400 text-lg">★</span> <span id="rating">8.5</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <a href="home.html" class="absolute top-6 left-6 flex items-center gap-2 bg-black/50 backdrop-blur px-4 py-2 rounded-full hover:bg-white/20 transition">
            <span class="material-symbols-rounded text-sm">arrow_back</span> Back
        </a>
    </div>

    <div class="border-b border-gray-800 bg-[#111] sticky top-0 z-40 shadow-xl">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center overflow-x-auto hide-scroll">
            <div id="date-container" class="flex gap-4"></div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-6 py-10 bg-[#0F0F0F] min-h-screen">
        <div id="theatre-list" class="flex flex-col gap-4">
            <div class="text-center py-20 animate-pulse text-gray-500">Finding Theaters nearby...</div>
        </div>
    </main>

    <div id="map-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 hidden opacity-0 pointer-events-none">
        <div class="bg-[#1a1a1a] w-full max-w-3xl h-[500px] rounded-xl overflow-hidden shadow-2xl border border-gray-800 relative">
            <button onclick="closeMap()" class="absolute top-4 right-4 z-[9999] bg-black/50 text-white p-2 rounded-full hover:bg-red-600 transition">
                <span class="material-symbols-rounded">close</span>
            </button>
            
            <div id="map"></div>
            
            <div class="absolute bottom-4 left-4 z-[9999] bg-white text-black px-4 py-2 rounded font-bold shadow-lg flex items-center gap-2">
                <span class="material-symbols-rounded text-red-600">location_on</span>
                <span id="map-label">Cinema Location</span>
            </div>
        </div>
    </div>

    <script>
        const API_GATEWAY = "http://localhost:8080";
        const IMAGE_BASE = "https://image.tmdb.org/t/p/original";
        const urlParams = new URLSearchParams(window.location.search);
        const MOVIE_ID = urlParams.get('id') || 550;
        const CITY_ID = urlParams.get('cityId') || 1; 

        let cachedCinemas = [];
        let selectedDateIndex = 0;
        const dates = [];
        
        // Map Variables
        let mapInstance = null;
        let markerInstance = null;

        document.addEventListener("DOMContentLoaded", () => {
            generateDates();
            fetchMovieDetails();
            fetchCinemas();
        });

        // --- EXISTING LOGIC (Dates, Movie Data) ---
        function generateDates() {
            const container = document.getElementById('date-container');
            container.innerHTML = "";
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            const today = new Date();

            for (let i = 0; i < 7; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                const dayName = i === 0 ? "TODAY" : i === 1 ? "TOM" : days[d.getDay()];
                const dayNum = d.getDate();
                dates.push({ short: `${dayName} ${dayNum}`, full: d.toDateString() });

                const btn = document.createElement('div');
                btn.className = `date-btn flex flex-col items-center px-4 py-2 rounded cursor-pointer ${i === 0 ? 'active' : 'text-gray-400 hover:bg-[#222]'}`;
                btn.innerHTML = `<span class="text-xs font-bold">${dayName}</span><span class="text-xl font-bold">${dayNum}</span>`;
                btn.onclick = () => selectDate(i, btn);
                container.appendChild(btn);
            }
        }

        function selectDate(index, btnElement) {
            document.querySelectorAll('.date-btn').forEach(b => {
                b.classList.remove('active');
                b.classList.add('text-gray-400', 'hover:bg-[#222]');
            });
            btnElement.classList.remove('text-gray-400', 'hover:bg-[#222]');
            btnElement.classList.add('active');
            selectedDateIndex = index;
            renderCinemas(cachedCinemas);
        }

        async function fetchMovieDetails() {
            try {
                const res = await fetch(`${API_GATEWAY}/movies/${MOVIE_ID}/details`);
                const data = await res.json();
                if(data.backdrop_path) document.getElementById('bg-backdrop').src = IMAGE_BASE + data.backdrop_path;
                if(data.poster_path) document.getElementById('poster-img').src = "https://image.tmdb.org/t/p/w500" + data.poster_path;
                document.getElementById('movie-title').innerText = data.title;
                document.getElementById('rating').innerText = data.vote_average?.toFixed(1) || "N/A";
                document.getElementById('release-date').innerText = data.release_date?.split("-")[0] || "2025";
            } catch(e) {}
        }

        async function fetchCinemas() {
            try {
                const res = await fetch(`${API_GATEWAY}/locations/cities/${CITY_ID}/cinemas`);
                cachedCinemas = await res.json();
                renderCinemas(cachedCinemas);
            } catch(e) {
                document.getElementById('theatre-list').innerHTML = `<div class="text-red-500 text-center">Failed to load cinemas.</div>`;
            }
        }

        // --- UPDATED: Render Cinemas with new Map Logic ---
        function renderCinemas(cinemas) {
            const container = document.getElementById('theatre-list');
            container.innerHTML = "";

            if (cinemas.length === 0) {
                container.innerHTML = `<div class="text-gray-500 text-center">No cinemas found.</div>`;
                return;
            }

            const shuffled = [...cinemas].sort(() => 0.5 - Math.random());
            const displayList = shuffled.slice(0, 15);

            displayList.forEach(c => {
                const times = generateRandomTimes();
                let timeHtml = "";
                times.forEach(t => {
                    const uniqueShowId = `${MOVIE_ID}_${c.id}_${selectedDateIndex}_${t.replace(/[: ]/g,'')}`;
                    timeHtml += `
                        <button onclick="bookShow('${uniqueShowId}', '${c.name}', '${t}')" 
                            class="time-btn border border-gray-600 rounded px-4 py-2 text-xs font-bold text-green-400 transition bg-[#1a1a1a]">
                            ${t} <div class="text-[8px] text-gray-500 font-normal mt-0.5">4K DOLBY</div>
                        </button>
                    `;
                });

                // New Logic: Extract Lat/Long safely
                const lat = c.latitude || 20.5937; 
                const lng = c.longitude || 78.9629;

                container.innerHTML += `
                    <div class="bg-[#151515] border-b border-[#222] p-6 flex flex-col md:flex-row gap-6 hover:bg-[#1a1a1a] transition group">
                        <div class="md:w-1/4">
                            <div class="flex items-center gap-2 text-white font-bold mb-1 group-hover:text-brand-red transition">
                                <span class="material-symbols-rounded text-sm text-gray-500">favorite</span>
                                ${c.name}
                            </div>
                            
                            <button onclick="openMapDirectly(${lat}, ${lng}, '${c.name}', '${c.address}')" 
                                class="mt-3 flex items-center gap-2 bg-gray-800 hover:bg-green-600 text-white px-3 py-1.5 rounded-full text-xs transition border border-gray-700 w-fit">
                                <span class="material-symbols-rounded text-[14px]">map</span> 
                                View Location
                            </button>
                            <div class="flex gap-4 text-[10px] text-purple-400 mt-2">
                                <span class="m-ticket">M-Ticket</span>
                                <span class="text-orange-400">● F&B</span>
                            </div>
                        </div>
                        <div class="md:w-3/4 flex flex-wrap gap-4 items-center">
                            ${timeHtml}
                        </div>
                    </div>
                `;
            });
        }

        function generateRandomTimes() {
            const allTimes = ["09:30 AM", "10:15 AM", "12:45 PM", "01:30 PM", "03:15 PM", "04:00 PM", "06:45 PM", "07:30 PM", "09:15 PM", "10:45 PM"];
            return allTimes.sort(() => 0.5 - Math.random()).slice(0, Math.floor(Math.random() * 4) + 3).sort();
        }

        function bookShow(showId, cinemaName, time) {
            const title = document.getElementById('movie-title').innerText;
            const dateObj = dates[selectedDateIndex];
            const fullTimeDisplay = `${dateObj.short}, ${time}`;
            window.location.href = `index.html?id=${showId}&title=${encodeURIComponent(title)}&cinema=${encodeURIComponent(cinemaName)}&time=${encodeURIComponent(fullTimeDisplay)}&tmdbId=${MOVIE_ID}`;
        }

        // --- NEW INSTANT MAP FUNCTION ---
        function openMapDirectly(lat, lng, name, address) {
            const modal = document.getElementById('map-modal');
            const label = document.getElementById('map-label');
            
            // 1. Show Modal
            modal.classList.remove('hidden', 'opacity-0', 'pointer-events-none');
            label.innerText = name;

            // 2. Initialize Map (only once)
            if (!mapInstance) {
                mapInstance = L.map('map').setView([lat, lng], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(mapInstance);
            } else {
                // If map exists, just fly to the new location
                mapInstance.setView([lat, lng], 15);
            }

            // 3. Update Marker
            if (markerInstance) {
                mapInstance.removeLayer(markerInstance);
            }
            
            markerInstance = L.marker([lat, lng]).addTo(mapInstance)
                .bindPopup(`<b>${name}</b><br>${address}`)
                .openPopup();
            
            // Fix map rendering issue (gray box) when opening hidden modal
            setTimeout(() => { mapInstance.invalidateSize(); }, 300);
        }

        function closeMap() {
            const modal = document.getElementById('map-modal');
            modal.classList.add('hidden', 'opacity-0', 'pointer-events-none');
        }

    </script>
</body>
</html>