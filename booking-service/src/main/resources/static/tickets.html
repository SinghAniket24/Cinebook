<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Tickets | CineBook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Manrope:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    <script src="js/auth-interceptor.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Manrope', 'sans-serif'], header: ['Bebas Neue', 'sans-serif'] },
                    colors: { brand: { red: '#E50914', dark: '#050505', card: '#121212' } }
                }
            }
        }
    </script>
    <style>
        body { background-color: #050505; color: white; }
        .glass-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="font-sans antialiased min-h-screen pb-20">

    <nav class="fixed top-0 w-full z-50 bg-[#050505]/90 backdrop-blur-md border-b border-white/5">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="window.location.href='http://localhost:8082/home.html'">
                <span class="material-symbols-rounded text-brand-red text-3xl">arrow_back</span>
                <h1 class="font-header text-2xl tracking-wide uppercase">My Bookings</h1>
            </div>
            <div class="flex items-center gap-3">
                <span id="user-name" class="text-sm font-bold text-gray-400">User</span>
                <div class="w-8 h-8 rounded-full bg-brand-red flex items-center justify-center text-xs font-black">U</div>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-6 pt-32">
        <div id="tickets-container" class="space-y-8">
            <div class="glass-card h-48 rounded-3xl animate-pulse"></div>
        </div>
        
        <div id="empty-state" class="hidden text-center py-20">
            <span class="material-symbols-rounded text-6xl text-gray-700 mb-4">confirmation_number</span>
            <h3 class="text-xl font-bold text-gray-400">No bookings found</h3>
            <button onclick="window.location.href='http://localhost:8082/home.html'" class="mt-6 text-brand-red font-bold hover:underline">Browse Movies</button>
        </div>
    </main>

    <script>
        // API Gateway Port (Always 8080 for backend logic)
        const API_BASE = "http://localhost:8080/bookings"; 

        document.addEventListener("DOMContentLoaded", () => {
            const userId = localStorage.getItem('userId');
            const userName = localStorage.getItem('username');
            
            if(userName) document.getElementById('user-name').innerText = userName;
            
            if(!userId) {
                // Updated to port 8082
                window.location.href = 'http://localhost:8082/login.html';
                return;
            }
            fetchBookings(userId);
        });

        async function fetchBookings(userId) {
            try {
                const res = await fetch(`${API_BASE}/user/${userId}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                
                if (!res.ok) throw new Error("Failed to fetch");
                
                const bookings = await res.json();
                renderTickets(bookings);
                
            } catch (e) {
                console.error(e);
                document.getElementById('tickets-container').innerHTML = `<p class="text-center text-red-500">Error loading tickets. Please login again.</p>`;
            }
        }

        function renderTickets(bookings) {
            const container = document.getElementById('tickets-container');
            container.innerHTML = "";

            if (bookings.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                container.classList.add('hidden');
                return;
            }

            bookings.reverse().forEach(b => {
                const statusColor = b.status === 'CONFIRMED' ? 'text-green-400' : 'text-gray-400';
                
                // Safe date formatting
                let dateObj = new Date();
                if(b.bookingTime) dateObj = new Date(b.bookingTime);
                
                const timeStr = dateObj.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

                container.innerHTML += `
                    <div class="relative bg-[#1a1a1a] rounded-3xl overflow-hidden flex flex-col md:flex-row shadow-2xl border border-white/5 group hover:border-white/10 transition-all">
                        
                        <div class="w-full md:w-32 bg-gradient-to-br from-brand-red to-red-900 flex items-center justify-center relative overflow-hidden">
                            <span class="material-symbols-rounded text-6xl text-white/20 absolute -bottom-4 -right-4">movie</span>
                            <div class="text-center p-4 z-10">
                                <span class="block text-2xl font-header text-white">${dateObj.getDate()}</span>
                                <span class="block text-xs font-bold text-white/80 uppercase">${dateObj.toLocaleString('default', { month: 'short' })}</span>
                            </div>
                        </div>

                        <div class="flex-1 p-8 flex flex-col justify-center">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-2xl font-black text-white uppercase tracking-wide">Booking #${b.id}</h3>
                                <span class="text-[10px] font-black uppercase tracking-widest border border-white/10 px-2 py-1 rounded bg-black/20 ${statusColor}">Confirmed</span>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4 mt-4 text-sm text-gray-400">
                                <div>
                                    <p class="text-[10px] font-bold uppercase tracking-widest text-gray-600">Movie ID</p>
                                    <p class="text-white font-bold">${b.movieId}</p>
                                </div>
                                <div>
                                    <p class="text-[10px] font-bold uppercase tracking-widest text-gray-600">Seats</p>
                                    <p class="text-white font-bold">Seat ${b.seatId}</p>
                                </div>
                                <div>
                                    <p class="text-[10px] font-bold uppercase tracking-widest text-gray-600">Time</p>
                                    <p class="text-white font-bold">${timeStr}</p>
                                </div>
                                <div>
                                    <p class="text-[10px] font-bold uppercase tracking-widest text-gray-600">Cinema</p>
                                    <p class="text-white font-bold">Main Screen</p>
                                </div>
                            </div>
                        </div>

                        <div class="border-t md:border-t-0 md:border-l border-dashed border-white/10 p-6 flex flex-col justify-center gap-3 bg-black/20">
                            
                            <button onclick="downloadTicket(${b.id})" 
                                class="bg-white text-black w-full py-3 rounded-xl font-black uppercase tracking-widest text-xs hover:bg-brand-red hover:text-white transition flex items-center justify-center gap-2 shadow-lg">
                                <span class="material-symbols-rounded text-lg">download</span>
                                Download PDF
                            </button>

                            <button class="text-gray-500 hover:text-white text-[10px] font-bold uppercase tracking-widest flex items-center justify-center gap-1 transition">
                                <span class="material-symbols-rounded text-sm">help</span> Support
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        // --- FIXED: SECURE DOWNLOAD FUNCTION ---
        async function downloadTicket(bookingId) {
            const token = localStorage.getItem('token');

            if (!token) {
                alert("Please log in to download tickets.");
                window.location.href = "http://localhost:8082/login.html";
                return;
            }

            try {
                // 1. Fetch PDF with Authorization Header
                const response = await fetch(`${API_BASE}/download/${bookingId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || "Download failed");
                }

                // 2. Convert response to Blob (File)
                const blob = await response.blob();

                // 3. Create a temporary download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `CineBook_Ticket_${bookingId}.pdf`; // The filename
                document.body.appendChild(a);

                // 4. Trigger click and cleanup
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

            } catch (error) {
                console.error("Download Error:", error);
                alert("Failed to download ticket. Please ensure you are logged in.");
            }
        }
    </script>
</body>
</html>